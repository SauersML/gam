name: Benchmark Suite

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * *"

env:
  CARGO_TERM_COLOR: always
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  R_LIBS_USER: ${{ github.workspace }}/.r-lib

jobs:
  prepare:
    name: Prepare benchmark matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build scenario matrix
        id: matrix
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path
          cfg = json.loads(Path("bench/scenarios.json").read_text())
          scenarios = cfg.get("scenarios", [])
          include = [{"scenario": s["name"]} for s in scenarios if "name" in s]
          if not include:
              raise SystemExit("No benchmark scenarios found in bench/scenarios.json")
          matrix = {"include": include}
          out = Path(os.environ["GITHUB_OUTPUT"])
          with out.open("a", encoding="utf-8") as fh:
              fh.write(f"matrix={json.dumps(matrix)}\n")
          print(json.dumps(matrix))
          PY

  bootstrap-runtime:
    name: Bootstrap benchmark runtime
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Build shared runtime once
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p bench/runtime/pydeps bench/runtime/r-lib
          python3 -m pip install --upgrade pip setuptools wheel
          python3 -m pip install --target bench/runtime/pydeps numpy pandas pygam lifelines
          Rscript -e 'install.packages(c("mgcv","jsonlite"), repos="https://cloud.r-project.org", lib="bench/runtime/r-lib")'
          cargo build --release --bin gam
          cp target/release/gam bench/runtime/gam
          chmod +x bench/runtime/gam

      - name: Upload shared runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: bench-runtime
          path: bench/runtime
          if-no-files-found: error

  bench-shard:
    name: Bench ${{ matrix.scenario }}
    needs:
      - prepare
      - bootstrap-runtime
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    env:
      OMP_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Download shared runtime
        uses: actions/download-artifact@v4
        with:
          name: bench-runtime
          path: bench/runtime

      - name: Run scenario shard
        shell: bash
        env:
          PYTHONPATH: ${{ github.workspace }}/bench/runtime/pydeps
          R_LIBS_USER: ${{ github.workspace }}/bench/runtime/r-lib
          BENCH_GAM_BIN: ${{ github.workspace }}/bench/runtime/gam
        run: |
          set -euo pipefail
          test -x "${BENCH_GAM_BIN}"
          mkdir -p bench/results-shards
          python3 bench/run_suite.py \
            --scenarios bench/scenarios.json \
            --scenario-name "${{ matrix.scenario }}" \
            --out "bench/results-shards/${{ matrix.scenario }}.json"

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: bench-${{ matrix.scenario }}
          path: bench/results-shards/${{ matrix.scenario }}.json
          if-no-files-found: error

  aggregate:
    name: Aggregate benchmark results
    needs: bench-shard
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download all shard artifacts
        uses: actions/download-artifact@v4
        with:
          path: bench/artifacts

      - name: Merge shard JSON outputs
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          from datetime import datetime, timezone
          from pathlib import Path

          artifacts = Path("bench/artifacts")
          files = sorted(artifacts.rglob("*.json"))
          if not files:
              raise SystemExit("No shard artifacts found to merge.")

          merged = []
          for fp in files:
              payload = json.loads(fp.read_text())
              merged.extend(payload.get("results", []))

          out = Path("bench/results.nightly.json")
          out.write_text(
              json.dumps(
                  {
                      "created_at_utc": datetime.now(timezone.utc).isoformat(),
                      "results": merged,
                  },
                  indent=2,
              )
          )
          print(f"Wrote {out} from {len(files)} shard files with {len(merged)} rows.")
          PY

      - name: Upload merged nightly results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-nightly
          path: bench/results.nightly.json
          if-no-files-found: error
